name: Deploy Release

on:
  push:
    branches:
      - stable

permissions:
  contents: write

env:
  SOLUTION_PATH: Xiaomi Software Manager.sln
  APP_PROJECT_PATH: Xiaomi Software Manager/xsm.csproj
  UPDATER_PROJECT_PATH: Updater/xsm.updater.csproj

jobs:
  release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Read version
        id: version
        shell: pwsh
        run: |
          [xml]$xml = Get-Content "${{ env.APP_PROJECT_PATH }}"
          $version = $xml.Project.PropertyGroup.Version | Select-Object -First 1
          if (-not $version) { throw "Version not found in project file." }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Restore NuGet packages
        run: dotnet restore "${{ env.SOLUTION_PATH }}"

      - name: Run tests
        run: dotnet test "${{ env.SOLUTION_PATH }}" --logger "console;verbosity=detailed" --verbosity normal

      - name: Publish app
        run: |
          dotnet publish "${{ env.APP_PROJECT_PATH }}" -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:EnableCompressionInSingleFile=true `
            /p:PublishReadyToRun=false `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:PublishDir="${{ github.workspace }}/publish/app"

      - name: Publish updater
        run: |
          dotnet publish "${{ env.UPDATER_PROJECT_PATH }}" -c Release -r win-x64 --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeNativeLibrariesForSelfExtract=true `
            /p:EnableCompressionInSingleFile=true `
            /p:PublishReadyToRun=false `
            /p:DebugType=None `
            /p:DebugSymbols=false `
            /p:PublishDir="${{ github.workspace }}/publish/updater"

      - name: Bundle updater into app
        shell: pwsh
        run: |
          Copy-Item "${{ github.workspace }}/publish/updater/xsm.updater.exe" `
            "${{ github.workspace }}/publish/app/xsm.updater.exe" -Force

      - name: Verify publish output
        shell: pwsh
        run: |
          & "${{ github.workspace }}/Xiaomi Software Manager/scripts/verify-publish.ps1" `
            -PublishDir "${{ github.workspace }}/publish/app"

      - name: Create zip
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $zipName = "xsm-win-x64-$version.zip"
          Compress-Archive -Path "${{ github.workspace }}/publish/app/*" -DestinationPath "${{ github.workspace }}/$zipName"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: xsm/v${{ steps.version.outputs.version }}
          target_commitish: ${{ github.sha }}
          files: |
            ${{ github.workspace }}/xsm-win-x64-${{ steps.version.outputs.version }}.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOWS_TOKEN }}
